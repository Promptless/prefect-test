---
title: Upgrade from agents to workers
description: Learn how to upgrade from agents to workers to significantly enhance the experience of deploying flows.
---

Upgrading from agents to workers significantly enhances the experience of deploying flows 
by simplifying the specification of each flow's infrastructure and runtime environment.

<Note>
This guide is for users who are on `prefect<3.0` who are upgrading from agents to workers.
If you are new to Prefect, we recommend starting with the 
[Prefect Quickstart](/3.0/get-started/quickstart/).
</Note>

```
    _____________________________________________________________________________________________
    | Provisioning infrastructure for your work pool my-aci-work-pool will require:             |
    |                                                                                           |
    |     Updates in subscription Azure subscription 1                                          |
    |                                                                                           |
    |         - Create a resource group in location eastus                                      |
    |         - Create an app registration in Azure AD prefect-aci-push-pool-app                |
    |         - Create/use a service principal for app registration                             |
    |         - Generate a secret for app registration                                          |
    |         - Create an Azure Container Registry with prefix prefect                           |
    |         - Create an identity prefect-acr-identity to allow access to the created registry |
    |         - Assign Contributor role to service account                                      |
    |         - Create an ACR registry for image hosting                                        |
    |         - Create an identity for Azure Container Instance to allow access to the registry |
    |                                                                                           |
    |     Updates in Prefect workspace                                                          |
    |                                                                                           |
    |         - Create Azure Container Instance credentials block aci-push-pool-credentials     |
    |                                                                                           |
    _____________________________________________________________________________________________
    Proceed with infrastructure provisioning? [y/n]:     
    Creating resource group
    Creating app registration
    Generating secret for app registration
    Creating ACI credentials block
    ACI credentials block 'aci-push-pool-credentials' created in Prefect Cloud
    Assigning Contributor role to service account
    Creating Azure Container Registry
    Creating identity
    Provisioning infrastructure... ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 100% 0:00:00
    Infrastructure successfully provisioned for 'my-aci-work-pool' work pool!
    Created work pool 'my-aci-work-pool'!
    Checking for active workers...
    Active workers found. Skipping worker start instructions.
    ```

    <Tip>
    **Default Docker build namespace**
        After infrastructure provisioning completes, you are logged into your new Azure Container Registry and 
        the default Docker build namespace is set to the URL of the registry.
    </Tip>

        While the default namespace is set, any images you build without specifying a registry or username/organization 
        are pushed to the registry.

        To use this capability, write your deploy scripts like this:

        ```python example_deploy_script.py
        from prefect import flow
        from prefect.docker import DockerImage                                


        @flow(log_prints=True)                                                         
        def my_flow(name: str = "world"):
            print(f"Hello {name}! I'm a flow running on an Azure Container Instance!") 


        if __name__ == "__main__":
            my_flow.deploy(                                                            
                name="my-deployment",
                work_pool_name="my-work-pool",                                    
                image=DockerImage(                                                 
                    name="my-image:latest",                                       
                    platform="linux/amd64",                                            
                )                                                                 
            )       
        ```

        This builds an image with the tag `<acr-registry-url>/my-image:latest` and pushes it to the registry.
  </Tab>
  <Tab title="Google Cloud Run">

```bash
prefect work-pool create --type cloud-run:push --provision-infra my-cloud-run-pool 
```

The `--provision-infra` flag allows you to select a GCP project to use for your work pool and automatically 
configures it to execute flows through Cloud Run.
In your GCP project, this command activates the Cloud Run API, creates a service account, and creates a key for the 
service account, (if they don't already exist).
In your Prefect workspace, this command creates a 
[`GCPCredentials` block](/integrations/prefect-gcp/index#authenticate-using-a-gcp-credentials-block) to store the service account key.

Here's an abbreviated example output from running the command:
```
    _____________________________________________________________________________________________
    | Provisioning infrastructure for your work pool my-aci-work-pool will require:             |
    |                                                                                           |
    |     Updates in subscription Azure subscription 1                                          |
    |                                                                                           |
    |         - Create a resource group in location eastus                                      |
    |         - Create an app registration in Azure AD prefect-aci-push-pool-app                |
    |         - Create/use a service principal for app registration                             |
    |         - Generate a secret for app registration                                          |
    |         - Create an Azure Container Registry with prefix prefect                           |
    |         - Create an identity prefect-acr-identity to allow access to the created registry |
    |         - Assign Contributor role to service account                                      |
    |         - Create an ACR registry for image hosting                                        |
    |         - Create an identity for Azure Container Instance to allow access to the registry |
    |                                                                                           |
    |     Updates in Prefect workspace                                                          |
    |                                                                                           |
    |         - Create Azure Container Instance credentials block aci-push-pool-credentials     |
    |                                                                                           |
    _____________________________________________________________________________________________
    Proceed with infrastructure provisioning? [y/n]:     
    Creating resource group
    Creating app registration
    Generating secret for app registration
    Creating ACI credentials block
    ACI credentials block 'aci-push-pool-credentials' created in Prefect Cloud
    Assigning Contributor role to service account
    Creating Azure Container Registry
    Creating identity
    Provisioning infrastructure... ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 100% 0:00:00
    Infrastructure successfully provisioned for 'my-aci-work-pool' work pool!
    Created work pool 'my-aci-work-pool'!
    Checking for active workers...
    Active workers found. Skipping worker start instructions.
    ```

    <Tip>
    **Default Docker build namespace**
        After infrastructure provisioning completes, you are logged into your new Azure Container Registry and 
        the default Docker build namespace is set to the URL of the registry.
    </Tip>

        While the default namespace is set, any images you build without specifying a registry or username/organization 
        are pushed to the registry.

        To use this capability, write your deploy scripts like this:

        ```python example_deploy_script.py
        from prefect import flow
        from prefect.docker import DockerImage                                


        @flow(log_prints=True)                                                         
        def my_flow(name: str = "world"):
            print(f"Hello {name}! I'm a flow running on an Azure Container Instance!") 


        if __name__ == "__main__":
            my_flow.deploy(                                                            
                name="my-deployment",
                work_pool_name="my-work-pool",                                    
                image=DockerImage(                                                 
                    name="my-image:latest",                                       
                    platform="linux/amd64",                                            
                )                                                                 
            )       
        ```

        This builds an image with the tag `<acr-registry-url>/my-image:latest` and pushes it to the registry.
  </Tab>
  <Tab title="Google Cloud Run">

```bash
prefect work-pool create --type cloud-run:push --provision-infra my-cloud-run-pool 
```

The `--provision-infra` flag allows you to select a GCP project to use for your work pool and automatically 
configures it to execute flows through Cloud Run.
In your GCP project, this command activates the Cloud Run API, creates a service account, and creates a key for the 
service account, (if they don't already exist).
In your Prefect workspace, this command creates a 
[`GCPCredentials` block](/integrations/prefect-gcp/index#authenticate-using-a-gcp-credentials-block) to store the service account key.

Here's an abbreviated example output from running the command:
```
    _____________________________________________________________________________________________
    | Provisioning infrastructure for your work pool my-aci-work-pool will require:             |
    |                                                                                           |
    |     Updates in subscription Azure subscription 1                                          |
    |                                                                                           |
    |         - Create a resource group in location eastus                                      |
    |         - Create an app registration in Azure AD prefect-aci-push-pool-app                |
    |         - Create/use a service principal for app registration                             |
    |         - Generate a secret for app registration                                          |
    |         - Create an Azure Container Registry with prefix prefect                           |
    |         - Create an identity prefect-acr-identity to allow access to the created registry |
    |         - Assign Contributor role to service account                                      |
    |         - Create an ACR registry for image hosting                                        |
    |         - Create an identity for Azure Container Instance to allow access to the registry |
    |                                                                                           |
    |     Updates in Prefect workspace                                                          |
    |                                                                                           |
    |         - Create Azure Container Instance credentials block aci-push-pool-credentials     |
    |                                                                                           |
    _____________________________________________________________________________________________
    Proceed with infrastructure provisioning? [y/n]:     
    Creating resource group
    Creating app registration
    Generating secret for app registration
    Creating ACI credentials block
    ACI credentials block 'aci-push-pool-credentials' created in Prefect Cloud
    Assigning Contributor role to service account
    Creating Azure Container Registry
    Creating identity
    Provisioning infrastructure... ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 100% 0:00:00
    Infrastructure successfully provisioned for 'my-aci-work-pool' work pool!
    Created work pool 'my-aci-work-pool'!
    Checking for active workers...
    Active workers found. Skipping worker start instructions.
    ```

    <Tip>
    **Default Docker build namespace**
        After infrastructure provisioning completes, you are logged into your new Azure Container Registry and 
        the default Docker build namespace is set to the URL of the registry.
    </Tip>

        While the default namespace is set, any images you build without specifying a registry or username/organization 
        are pushed to the registry.

        To use this capability, write your deploy scripts like this:

        ```python example_deploy_script.py
        from prefect import flow
        from prefect.docker import DockerImage                                


        @flow(log_prints=True)                                                         
        def my_flow(name: str = "world"):
            print(f"Hello {name}! I'm a flow running on an Azure Container Instance!") 


        if __name__ == "__main__":
            my_flow.deploy(                                                            
                name="my-deployment",
                work_pool_name="my-work-pool",                                    
                image=DockerImage(                                                 
                    name="my-image:latest",                                       
                    platform="linux/amd64",                                            
                )                                                                 
            )       
        ```

        This builds an image with the tag `<acr-registry-url>/my-image:latest` and pushes it to the registry.
  </Tab>
  <Tab title="Google Cloud Run">

```bash
prefect work-pool create --type cloud-run:push --provision-infra my-cloud-run-pool 
```

The `--provision-infra` flag allows you to select a GCP project to use for your work pool and automatically 
configures it to execute flows through Cloud Run.
In your GCP project, this command activates the Cloud Run API, creates a service account, and creates a key for the 
service account, (if they don't already exist).
In your Prefect workspace, this command creates a 
[`GCPCredentials` block](/integrations/prefect-gcp/index#authenticate-using-a-gcp-credentials-block) to store the service account key.

Here's an abbreviated example output from running the command:
## What's similar

- You can set storage blocks as the pull action in a `prefect.yaml` file.
- Infrastructure blocks have configuration fields similar to typed work pools.
- Deployment-level infrastructure overrides operate in much the same way.

    `infra_override` -> [`job_variable`](/3.0/deploy/infrastructure-concepts/prefect-yaml/#work-pool-fields)

- The process for starting an agent and [starting a worker](/3.0/deploy/infrastructure-concepts/workers/#start-a-worker) 
in your environment are virtually identical.

    `prefect agent start --pool <work pool name>` --> `prefect worker start --pool <work pool name>`
<Tip>
**Worker Helm chart**

If you host your agents in a Kubernetes cluster, you can use the [Prefect worker Helm chart](https://github.com/PrefectHQ/prefect-helm/tree/main/charts/prefect-worker) 
to host workers in your cluster.
</Tip>

```
    _____________________________________________________________________________________________
    | Provisioning infrastructure for your work pool my-aci-work-pool will require:             |
    |                                                                                           |
    |     Updates in subscription Azure subscription 1                                          |
    |                                                                                           |
    |         - Create a resource group in location eastus                                      |
    |         - Create an app registration in Azure AD prefect-aci-push-pool-app                |
    |         - Create/use a service principal for app registration                             |
    |         - Generate a secret for app registration                                          |
    |         - Create an Azure Container Registry with prefix prefect                           |
    |         - Create an identity prefect-acr-identity to allow access to the created registry |
    |         - Assign Contributor role to service account                                      |
    |         - Create an ACR registry for image hosting                                        |
    |         - Create an identity for Azure Container Instance to allow access to the registry |
    |                                                                                           |
    |     Updates in Prefect workspace                                                          |
    |                                                                                           |
    |         - Create Azure Container Instance credentials block aci-push-pool-credentials     |
    |                                                                                           |
    _____________________________________________________________________________________________
    Proceed with infrastructure provisioning? [y/n]:     
    Creating resource group
    Creating app registration
    Generating secret for app registration
    Creating ACI credentials block
    ACI credentials block 'aci-push-pool-credentials' created in Prefect Cloud
    Assigning Contributor role to service account
    Creating Azure Container Registry
    Creating identity
    Provisioning infrastructure... ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 100% 0:00:00
    Infrastructure successfully provisioned for 'my-aci-work-pool' work pool!
    Created work pool 'my-aci-work-pool'!
    Checking for active workers...
    Active workers found. Skipping worker start instructions.
    ```

    <Tip>
    **Default Docker build namespace**
        After infrastructure provisioning completes, you are logged into your new Azure Container Registry and 
        the default Docker build namespace is set to the URL of the registry.
    </Tip>

        While the default namespace is set, any images you build without specifying a registry or username/organization 
        are pushed to the registry.

        To use this capability, write your deploy scripts like this:

        ```python example_deploy_script.py
        from prefect import flow
        from prefect.docker import DockerImage                                


        @flow(log_prints=True)                                                         
        def my_flow(name: str = "world"):
            print(f"Hello {name}! I'm a flow running on an Azure Container Instance!") 


        if __name__ == "__main__":
            my_flow.deploy(                                                            
                name="my-deployment",
                work_pool_name="my-work-pool",                                    
                image=DockerImage(                                                 
                    name="my-image:latest",                                       
                    platform="linux/amd64",                                            
                )                                                                 
            )       
        ```

        This builds an image with the tag `<acr-registry-url>/my-image:latest` and pushes it to the registry.
  </Tab>
  <Tab title="Google Cloud Run">

```bash
prefect work-pool create --type cloud-run:push --provision-infra my-cloud-run-pool 
```

The `--provision-infra` flag allows you to select a GCP project to use for your work pool and automatically 
configures it to execute flows through Cloud Run.
In your GCP project, this command activates the Cloud Run API, creates a service account, and creates a key for the 
service account, (if they don't already exist).
In your Prefect workspace, this command creates a 
[`GCPCredentials` block](/integrations/prefect-gcp/index#authenticate-using-a-gcp-credentials-block) to store the service account key.

Here's an abbreviated example output from running the command:
### Use `flow.deploy`

If you have a Python script that uses `Deployment.build_from_flow` to create a deployment, you
can replace it with `flow.deploy`.

You can translate most arguments to `Deployment.build_from_flow` directly to `flow.deploy`, 
but here are some possible changes you may need:

- Replace `infrastructure` with `work_pool_name`.
  - If you've used the `.publish_as_work_pool` method on your infrastructure block, use the 
  name of the created work pool.
- Replace `infra_overrides` with `job_variables`.
- Replace `storage` with a call to [`flow.from_source`](/3.0/deploy/index).
  - `flow.from_source` loads your flow from a remote storage location and makes it deployable. 
  You can pass your existing storage block to the `source` argument of `flow.from_source`.

Below are some examples of how to translate `Deployment.build_from_flow` into `flow.deploy`.

#### Deploying from a local file

Using agents and `Deployment.build_from_flow` to deploy a flow from a local file looked like:

```python
from prefect import flow


@flow(log_prints=True)
def my_flow(name: str = "world"):
    print(f"Hello {name}! I'm a flow from a Python script!")


if __name__ == "__main__":
    Deployment.build_from_flow(
        my_flow,
        name="my-deployment",
        parameters=dict(name="Marvin"),
    )
```

When using workers, you can accomplish the same local-storage deployment with `flow.deploy`:

```python example.py
from pathlib import Path
from prefect import flow


@flow(log_prints=True)
def my_flow(name: str = "world"):
    print(f"Hello {name}! I'm a flow from a Python script!")


if __name__ == "__main__":
    my_flow.from_source(
        source=str(Path(__file__).parent),
        entrypoint="example.py:my_flow",
    ).deploy(
        name="my-deployment",
        parameters=dict(name="Marvin"),
        work_pool_name="local",
    )
```

You can then start a worker to execute scheduled runs, pulling the flow code from `example.py`:

```bash
# starts a worker and creates `local` Process work pool if it doesn't exist
prefect worker start --pool local
```

<Note>
If you'd like to immediately serve this flow as a deployment without running a worker or using work pools, you can [use `flow.serve`](/3.0/deploy/run-flows-in-local-processes/).
</Note>

#### Deploying using a storage block

If you currently use a storage block to load your flow code but no infrastructure block:

```python
from prefect import flow
from prefect.storage import GitHub

  
@flow(log_prints=True)
def my_flow(name: str = "world"):
    print(f"Hello {name}! I'm a flow from a GitHub repo!")


if __name__ == "__main__":
    Deployment.build_from_flow(
        my_flow,
        name="my-deployment",
        storage=GitHub.load("demo-repo"),
        parameters=dict(name="Marvin"),
    )
```

You can use `flow.from_source` to load your flow from the same location and `flow.deploy` to 
create a deployment:

```python example.py
from prefect import flow
from prefect.runner.storage import GitRepository

@flow(log_prints=True)
def my_flow(name: str = "world"):
    print(f"Hello {name}! I'm a flow from a GitHub repo!")

if __name__ == "__main__":
    flow.from_source(
        source=GitRepository(
            url="https://github.com/me/myrepo.git",
            credentials={"username": "oauth2", "access_token": "my-access-token"},
        ),
        entrypoint="example.py:my_flow"
    ).deploy(
        name="my-deployment",
        parameters=dict(name="Marvin"),
        work_pool_name="local", # or the name of your work pool
    )
```

#### Deploy using an infrastructure block and a storage block

For the code below, you need to create a work pool from your infrastructure block and pass it to 
`flow.deploy` as the `work_pool_name` argument. You also need to pass your storage block to 
`flow.from_source` as the `source` argument.

```python example.py
from prefect import flow
from prefect.deployments import Deployment
from prefect.filesystems import GitHub
from prefect.infrastructure.kubernetes import KubernetesJob


@flow(log_prints=True)
def my_flow(name: str = "world"):
    print(f"Hello {name}! I'm a flow from a GitHub repo!")


if __name__ == "__main__":
    Deployment.build_from_flow(
        my_flow,
        name="my-deployment",
        storage=GitHub.load("demo-repo"),
        entrypoint="example.py:my_flow",
        infrastructure=KubernetesJob.load("my-k8s-job"),
        infra_overrides=dict(pull_policy="Never"),
        parameters=dict(name="Marvin"),
    )
```

The equivalent deployment code using `flow.deploy` should look like this:

```python example.py
from prefect import flow
from prefect.storage import GitHub

if __name__ == "__main__":
    flow.from_source(
        source=GitHub.load("demo-repo"),
        entrypoint="example.py:my_flow"
    ).deploy(
        name="my-deployment",
        work_pool_name="my-k8s-job",
        job_variables=dict(pull_policy="Never"),
        parameters=dict(name="Marvin"),
    )
```
{/*
<!-- vale off -->
*/}

<Note>
When using `flow.from_source().deploy()` with a remote `source`such as a `GitHub` block or `str` URL like https://github.com/me/myrepo.git), the flow you're deploying doesn't need to be available locally before running your script.
See the [SDK reference](https://prefect-python-sdk-docs.netlify.app/prefect/#prefect.Flow.from_source) for more info on `from_source`.
</Note>

{/*
<!-- vale on -->
*/}

#### Deploy via a Docker image

If you currently bake your flow code into a Docker image before deploying, you can use the 
`image` argument of `flow.deploy` to build a Docker image as part of your deployment process:

```python
from prefect import flow

@flow(log_prints=True)
def my_flow(name: str = "world"):
    print(f"Hello {name}! I'm a flow from a Docker image!")


if __name__ == "__main__":
    my_flow.deploy(
        name="my-deployment",
        image="my-repo/my-image:latest",
        work_pool_name="my-k8s-job",
        job_variables=dict(pull_policy="Never"),
        parameters=dict(name="Marvin"),
    )
```

You can skip a `flow.from_source` call when building an image with `flow.deploy`. Prefect 
keeps track of the flow's source code location in the image and loads it from that location when the 
flow is executed.

### Use `prefect deploy`

<Warning>
**Always run `prefect deploy` commands from the `root` level of your repo!**

With agents, you may have multiple `deployment.yaml` files. But under worker deployment 
patterns, each repo has a single `prefect.yaml` file located at the **root** of the repo 
that contains [deployment configuration](/3.0/deploy/infrastructure-concepts/prefect-yaml/#work-with-multiple-deployments-with-prefect-yaml) 
for all flows in that repo.
</Warning>

To set up a new `prefect.yaml` file for your deployments, run the following command from the root 
level of your repo:

```bash
prefect deploy
```

This starts a wizard that guides you through setting up your deployment.

<Note>
**For step 4, select `y` on the last prompt to save the configuration for the deployment.**

Saving the configuration for your deployment results in a `prefect.yaml` file populated 
with your first deployment. You can use this YAML file to edit and [define multiple deployments](/3.0/deploy/infrastructure-concepts/prefect-yaml/#work-with-multiple-deployments-with-prefect-yaml) 
for this repo.
</Note>

You can add more [deployments](/3.0/deploy/infrastructure-concepts/prefect-yaml/#deployment-declaration-reference) 
to the `deployments` list in your `prefect.yaml` file and/or by continuing to use the deployment 
creation wizard.

For more information on deployments, check out our [in-depth guide for deploying flows to work pools](/3.0/deploy/infrastructure-examples/docker/).